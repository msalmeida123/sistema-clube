version: '3.8'

# ==============================================
# SISTEMA CLUBE v1.2.0 - Stack para Portainer
# Deploy: Docker Swarm
# Inclui: Web Admin + App Mobile Associado
# ==============================================

services:
  # ========================================
  # Sistema Web (Admin/FuncionÃ¡rios)
  # ========================================
  sistema-clube:
    image: ghcr.io/msalmeida123/sistema-clube-web:latest
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.sistema-clube.rule=Host(`clube.mindforge.dev.br`)"
        - "traefik.http.routers.sistema-clube.entrypoints=websecure"
        - "traefik.http.routers.sistema-clube.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.sistema-clube.loadbalancer.server.port=3000"
        - "traefik.docker.network=network_swarm_public"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_SUPABASE_URL=https://fkjjjpgxkjhqkhmdpmzk.supabase.co
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrampqcGd4a2pocWtobWRwbXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2MDI0NTYsImV4cCI6MjA4MjE3ODQ1Nn0.c0wUGT2Ah2RW5lPJ5EhS738349AdvXsnnsoQvNjM5PY
    networks:
      - network_swarm_public
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://localhost:3000').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # ========================================
  # App Mobile Associado (Next.js PWA)
  # ========================================
  app-associado:
    image: ghcr.io/msalmeida123/clube-associado:latest
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.app-associado.rule=Host(`app.mindforge.dev.br`)"
        - "traefik.http.routers.app-associado.entrypoints=websecure"
        - "traefik.http.routers.app-associado.tls.certresolver=letsencryptresolver"
        - "traefik.http.services.app-associado.loadbalancer.server.port=3000"
        - "traefik.docker.network=network_swarm_public"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_SUPABASE_URL=https://fkjjjpgxkjhqkhmdpmzk.supabase.co
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrampqcGd4a2pocWtobWRwbXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2MDI0NTYsImV4cCI6MjA4MjE3ODQ1Nn0.c0wUGT2Ah2RW5lPJ5EhS738349AdvXsnnsoQvNjM5PY
    networks:
      - network_swarm_public
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://localhost:3000').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

networks:
  network_swarm_public:
    external: true
